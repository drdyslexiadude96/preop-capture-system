<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container {
  max-width:1000px;
  margin:auto;
  background:#fff;
  padding:30px;
  border-radius:10px;
}
.section {
  border-top:1px solid #ddd;
  margin-top:30px;
  padding-top:20px;
}
.preview {
  max-width:240px;
  display:block;
  margin:10px 0;
  border:1px solid #ccc;
}
.status {
  font-weight:bold;
  margin-left:10px;
}
.complete { color:green; }
.incomplete { color:red; }

button {
  padding:16px 24px;
  font-size:18px;
  margin-top:40px;
  cursor:pointer;
}
button:disabled {
  opacity:0.5;
  cursor:not-allowed;
}

h2,h3 { margin-bottom:10px; }

.footer-note {
  font-size:10px;
  color:#555;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">

<h1>Pre-Operative Dental & Airway Capture System</h1>
<p><strong>Patent Pending</strong></p>

<label>
Patient / Session ID:
<input type="text" id="sessionId" placeholder="Auto-generated if left blank">
</label>

<!-- I1 AIRWAY -->
<div class="section">
<h2>I1 – Airway View <span id="status-I1" class="status incomplete">Incomplete</span></h2>
<input type="file" id="airwayImage" accept="image/*">
<img id="airwayPreview" class="preview">

<label><input type="checkbox" id="tongueObstruction"> Tongue obstruction noted</label>

<label>Mallampati Class:
<select id="mallampati">
<option value="">Select</option>
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>
</label>

<h3>Mallampati Rationale (Observed)</h3>
<label><input type="checkbox" id="softPalate"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hardPalate"> Only hard palate visible</label>
</div>

<!-- DENTITION -->
<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<button id="generateBtn" disabled>Generate PDF Report</button>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

const dentitionViews = [
  { id:"I2", label:"Upper Dentition" },
  { id:"I3", label:"Lower Dentition" },
  { id:"I4", label:"Right Molars" },
  { id:"I5", label:"Left Molars" },
  { id:"I6", label:"Natural Occlusion", occlusion:true }
];

const dentDiv = document.getElementById("dentition");

dentitionViews.forEach(v => {
  dentDiv.insertAdjacentHTML("beforeend", `
    <div class="section">
      <h3>${v.id} – ${v.label} <span id="status-${v.id}" class="status incomplete">Incomplete</span></h3>
      <input type="file" id="${v.id}img" accept="image/*">
      <img id="${v.id}prev" class="preview">

      <label><input type="checkbox" id="${v.id}missing"> Missing teeth</label>
      <label><input type="checkbox" id="${v.id}crowns"> Crowns / restorations</label>
      <label><input type="checkbox" id="${v.id}chips"> Chips / fractures</label>
      ${v.occlusion ? `<label><input type="checkbox" id="${v.id}occlusion"> Occlusal instability noted</label>` : ""}
    </div>
  `);
});

function bindPreview(inputId, imgId, statusId) {
  const input = document.getElementById(inputId);
  const img = document.getElementById(imgId);
  input.addEventListener("change", () => {
    if (input.files[0]) {
      img.src = URL.createObjectURL(input.files[0]);
      document.getElementById(statusId).textContent = "Complete";
      document.getElementById(statusId).className = "status complete";
      validateReady();
    }
  });
}

bindPreview("airwayImage","airwayPreview","status-I1");
dentitionViews.forEach(v => bindPreview(v.id+"img", v.id+"prev", "status-"+v.id));

function validateReady() {
  const allComplete = ["I1","I2","I3","I4","I5","I6"]
    .every(id => document.getElementById("status-"+id).classList.contains("complete"));
  document.getElementById("generateBtn").disabled = !allComplete;
}

function formatTimestampUTC() {
  const d = new Date();
  return d.toLocaleString("en-US", {
    timeZone: "UTC",
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  }) + " UTC";
}

document.getElementById("generateBtn").onclick = generatePDF;

async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const session = sessionId.value || "AUTO-" + Date.now();
  const timestamp = formatTimestampUTC();

  let y = 15;
  pdf.setFontSize(18);
  pdf.text("Pre-Operative Dental & Airway Report",10,y); y+=8;
  pdf.setFontSize(10);
  pdf.text("Patent Pending • Clinical documentation support tool",10,y); y+=10;

  pdf.setFontSize(12);
  pdf.text(`Session ID: ${session}`,10,y); y+=6;
  pdf.text(`Capture Timestamp (UTC): ${timestamp}`,10,y); y+=8;

  pdf.setFontSize(14);
  pdf.text("Airway Assessment",10,y); y+=8;

  const mall = mallampati.value;
  const tongue = tongueObstruction.checked;

  let risk = "LOW";
  if (mall === "III" || mall === "IV" || tongue) risk = "MODERATE";
  if (mall === "IV" && tongue) risk = "HIGH";

  pdf.setFontSize(12);
  pdf.text(`Mallampati Class: ${mall}`,10,y); y+=6;
  pdf.text(`Tongue Obstruction: ${tongue?"Yes":"No"}`,10,y); y+=6;
  pdf.text(`Airway Risk Stratification (Rules-Based): ${risk}`,10,y); y+=8;

  if (airwayPreview.src) {
    pdf.addImage(airwayPreview,"JPEG",10,y,70,70);
    y+=80;
  }

  pdf.addPage();
  y=15;
  pdf.setFontSize(14);
  pdf.text("Dentition Findings",10,y); y+=8;

  dentitionViews.forEach(v=>{
    pdf.setFontSize(12);
    pdf.text(`${v.id} – ${v.label}`,10,y); y+=6;

    const img = document.getElementById(v.id+"prev");
    if(img.src) pdf.addImage(img,"JPEG",10,y,60,60);

    y+=70;
    if(y>260){ pdf.addPage(); y=15; }
  });

  pdf.setFontSize(10);
  pdf.text("Patent Pending",10,285);

  pdf.save(`PreOp_${session}.pdf`);
}

});
</script>

</body>
</html>
