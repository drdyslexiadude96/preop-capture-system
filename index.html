<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { max-width:1000px; margin:auto; background:#fff; padding:30px; border-radius:10px; }
.section { border-top:1px solid #ddd; margin-top:30px; padding-top:20px; }
.preview { max-width:220px; display:block; margin:10px 0; border:1px solid #ccc; }
label { display:block; margin:6px 0; }
button { padding:16px 24px; font-size:18px; margin-top:40px; cursor:pointer; }
button:disabled { opacity:0.5; cursor:not-allowed; }
.status { font-weight:bold; margin-left:10px; }
.complete { color:green; }
.incomplete { color:red; }
</style>
</head>

<body>
<div class="container">
<h1>Pre-Operative Dental & Airway Capture System</h1>

<label>
Patient / Session ID:
<input id="sessionId" placeholder="Auto-generated if left blank">
</label>

<!-- I1 -->
<div class="section">
<h2>I1 – Airway View <span id="s_I1" class="status incomplete">Incomplete</span></h2>
<input type="file" id="I1img" accept="image/*">
<img id="I1prev" class="preview">

<label><input type="checkbox" id="tongueObstruction"> Tongue obstruction noted</label>

<label>Mallampati Class:
<select id="mallampati">
<option value="">Select</option>
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>
</label>
</div>

<!-- Dentition -->
<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<button id="generateBtn" disabled>Generate PDF Report</button>
</div>

<script>
const views = [
  {id:"I2",label:"Upper Dentition"},
  {id:"I3",label:"Lower Dentition"},
  {id:"I4",label:"Right Molars"},
  {id:"I5",label:"Left Molars"},
  {id:"I6",label:"Natural Occlusion",occlusion:true}
];

const dentDiv = document.getElementById("dentition");

views.forEach(v=>{
  dentDiv.insertAdjacentHTML("beforeend",`
    <div class="section">
      <h3>${v.id} – ${v.label} <span id="s_${v.id}" class="status incomplete">Incomplete</span></h3>
      <input type="file" id="${v.id}img" accept="image/*">
      <img id="${v.id}prev" class="preview">

      <label><input type="checkbox" id="${v.id}missing"> Missing teeth</label>
      <label><input type="checkbox" id="${v.id}crowns"> Crowns / restorations</label>
      <label><input type="checkbox" id="${v.id}chips"> Chips / fractures</label>
      ${v.occlusion ? `<label><input type="checkbox" id="${v.id}occlusion"> Occlusal instability</label>` : ""}
    </div>
  `);
});

function bindPreview(id){
  const input=document.getElementById(id+"img");
  const img=document.getElementById(id+"prev");
  const status=document.getElementById("s_"+id);
  input.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{ img.src=r.result; status.textContent="Complete"; status.className="status complete"; checkReady(); };
    r.readAsDataURL(e.target.files[0]);
  };
}

bindPreview("I1");
views.forEach(v=>bindPreview(v.id));
mallampati.onchange = checkReady;

function checkReady(){
  const allImages =
    I1prev.src &&
    views.every(v=>document.getElementById(v.id+"prev").src);

  generateBtn.disabled = !(allImages && mallampati.value);
}

generateBtn.onclick = generatePDF;

function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const sid = sessionId.value || "SESSION-"+Date.now();
  const now = new Date();
  const ts = now.toISOString();

  const fname =
    `PreOp_Dental_Airway_Report_${sid}_`+
    `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}`+
    `${String(now.getDate()).padStart(2,"0")}_`+
    `${String(now.getHours()).padStart(2,"0")}${String(now.getMinutes()).padStart(2,"0")}.pdf`;

  let y=15;
  pdf.setFontSize(16);
  pdf.text("Pre-Operative Dental & Airway Report",10,y); y+=10;
  pdf.setFontSize(12);
  pdf.text(`Session ID: ${sid}`,10,y); y+=6;
  pdf.text(`Timestamp (UTC): ${ts}`,10,y); y+=10;

  pdf.addImage(I1prev.src,"JPEG",10,y,70,70);
  y+=80;

  pdf.addPage(); y=15;
  views.forEach(v=>{
    pdf.text(`${v.id} – ${v.label}`,10,y); y+=6;
    pdf.addImage(document.getElementById(v.id+"prev").src,"JPEG",10,y,60,60);
    y+=70;
    if(y>250){ pdf.addPage(); y=15; }
  });

  pdf.setFontSize(9);
  pdf.text("Version 1.0 • Patent Pending",10,290);

  pdf.save(fname);
}
</script>
</body>
</html>
