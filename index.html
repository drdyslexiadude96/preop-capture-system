<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin: 30px; }
h1 { font-size: 34px; }
h2 { margin-top: 30px; }
.section { margin-bottom: 25px; }
label { display: block; margin: 6px 0; }
.complete { color: green; font-weight: bold; }
.incomplete { color: red; font-weight: bold; }
button { padding: 10px 18px; font-size: 16px; }
input[type="text"] { padding: 5px; }
img.preview { max-width: 260px; margin-top: 8px; border: 1px solid #ccc; }
hr { margin: 25px 0; }
</style>
</head>

<body>

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong><br><br>

<label>
Patient / Session ID:
<input type="text" id="sessionId" placeholder="Auto-generated if left blank">
</label>

<hr>

<!-- I1 -->
<div class="section">
<h2>I1 — Airway View <span id="s1" class="incomplete">Incomplete</span></h2>

<input type="file" id="i1"><br>

<label><input type="checkbox" id="tongueObs"> Tongue obstruction noted</label>

<label>
Mallampati:
<select id="mallampati">
<option value="">Select</option>
<option>I</option>
<option>II</option>
<option>III</option>
<option>IV</option>
</select>
</label>

<h3>Mallampati Rationale (Observed)</h3>
<label><input type="checkbox" id="soft"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hard"> Only hard palate visible</label>
</div>

<hr>

<!-- I2–I6 -->
<div class="section">
<h2>Dentition Images</h2>

<div>I2 — Upper Dentition <span id="s2" class="incomplete">Incomplete</span><br>
<input type="file" id="i2"><br>
<img id="p2" class="preview"></div><hr>

<div>I3 — Lower Dentition <span id="s3" class="incomplete">Incomplete</span><br>
<input type="file" id="i3"><br>
<img id="p3" class="preview"></div><hr>

<div>I4 — Right Molars <span id="s4" class="incomplete">Incomplete</span><br>
<input type="file" id="i4"><br>
<img id="p4" class="preview"></div><hr>

<div>I5 — Left Molars <span id="s5" class="incomplete">Incomplete</span><br>
<input type="file" id="i5"><br>
<img id="p5" class="preview"></div><hr>

<div>I6 — Natural Occlusion <span id="s6" class="incomplete">Incomplete</span><br>
<input type="file" id="i6"><br>
<img id="p6" class="preview"></div>
</div>

<hr>

<!-- LAYER 2 -->
<div class="section">
<h2>Clinical Interpretation</h2>

<div id="clinicalBox"><em>Complete airway inputs to generate interpretation.</em></div>

<h3>Reviewer</h3>
<label>Reviewed by: <input type="text" id="reviewer"></label>
<label>
Role:
<select id="role">
<option value="">Select</option>
<option>Anesthesiologist</option>
<option>CRNA</option>
<option>Other</option>
</select>
</label>
<label><input type="checkbox" id="reviewed"> Reviewed prior to induction</label>
</div>

<hr>

<button id="pdfBtn" disabled onclick="generatePDF()">Generate PDF Report</button>

<script>
const files = ["i1","i2","i3","i4","i5","i6"];

files.forEach((id,i)=>{
  document.getElementById(id).addEventListener("change", e=>{
    if(id !== "i1"){
      document.getElementById("p"+(i+1)).src = URL.createObjectURL(e.target.files[0]);
    }
    document.getElementById("s"+(i+1)).textContent="Complete";
    document.getElementById("s"+(i+1)).className="complete";
    checkReady();
  });
});

function checkReady(){
  const all = files.every(id=>document.getElementById(id).files.length>0);
  document.getElementById("pdfBtn").disabled = !all;
}

function cstTime(){
  return new Date().toLocaleString("en-US",{timeZone:"America/Chicago",hour12:true});
}

["mallampati","tongueObs","soft","uvula","pillars","hard"].forEach(id=>{
  document.getElementById(id).addEventListener("change",updateInterpretation);
});

function updateInterpretation(){
  const m = mallampati.value;
  if(!m) return;

  const tongue = tongueObs.checked;
  let risk = "MODERATE";
  if(m==="III"||m==="IV"||tongue) risk="HIGH";

  let rationale=[];
  if(soft.checked) rationale.push("Soft palate visible");
  if(uvula.checked) rationale.push("Uvula visible");
  if(pillars.checked) rationale.push("Faucial pillars visible");
  if(hard.checked) rationale.push("Only hard palate visible");

  clinicalBox.innerHTML = `
    <strong>Airway Risk:</strong> ${risk}<br>
    <strong>Interpretation:</strong> Mallampati ${m}${tongue?" with tongue obstruction noted.":"."}<br><br>
    <strong>Observed Findings:</strong><br>
    ${rationale.length ? rationale.join("<br>") : "—"}
  `;
}

function generatePDF(){
  const sid = sessionId.value || "SESSION-"+Date.now();
  const riskText = document.getElementById("clinicalBox").innerText;

  const pdf = document.createElement("div");
  pdf.innerHTML = `
    <h1>Pre-Operative Dental & Airway Report</h1>
    <p><strong>Patent Pending</strong></p>
    <p><strong>Session ID:</strong> ${sid}</p>
    <p><strong>Assessment Level:</strong> ${riskText.includes("HIGH")?"HIGH":"MODERATE"}</p>
    <p><strong>Capture Timestamp (CST):</strong> ${cstTime()}</p>
    <hr>
    <pre>${riskText}</pre>
    <p><strong>Reviewed by:</strong> ${reviewer.value||"—"}</p>
    <p><strong>Role:</strong> ${role.value||"—"}</p>
    <p><strong>Reviewed prior to induction:</strong> ${reviewed.checked?"Yes":"No"}</p>
  `;

  html2pdf().from(pdf).save(`PreOp_${sid}.pdf`);
}
</script>

</body>
</html>
