<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin:30px; }
h1 { font-size:34px; }
h2 { margin-top:30px; }
.section { margin-bottom:30px; border-bottom:1px solid #ccc; padding-bottom:20px; }
.complete { color:green; font-weight:bold; }
.incomplete { color:red; font-weight:bold; }
img.preview { max-width:260px; display:block; margin-top:10px; border:1px solid #ccc; }
label { display:block; margin:6px 0; font-weight:bold; }
input[type=text], select, textarea {
  width:100%;
  padding:10px;
  font-size:16px;
  box-sizing:border-box;
}
textarea { min-height:80px; }
button { padding:12px 22px; font-size:18px; margin-top:20px; }
.readonly { background:#f4f4f4; }
</style>
</head>

<body>

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong><br><br>

<label>Patient / Session ID</label>
<input type="text" id="sessionId" value="Patient Pending">

<div class="section">
<h2>I1 — Airway View <span id="i1Status" class="incomplete">Incomplete</span></h2>

<input type="file" accept="image/*" onchange="loadImage(this,'airwayImg','i1Status')">
<img id="airwayImg" class="preview">

<label>Mallampati</label>
<select id="mallampati">
<option value="">Select</option>
<option value="I">I</option>
<option value="II">II</option>
<option value="III">III</option>
<option value="IV">IV</option>
</select>

<label><input type="checkbox" id="tongueObs"> Tongue obstruction noted</label>

<label>Mallampati Rationale (Observed)</label>
<label><input type="checkbox" id="soft"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hard"> Only hard palate visible</label>
</div>

<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<div class="section" id="clinicalBox">
<h2>Clinical Interpretation</h2>

<label>Airway Risk</label>
<input type="text" id="airwayRisk" class="readonly" readonly>

<label>Risk Description</label>
<textarea id="riskDescription" class="readonly" readonly></textarea>

<label>Interpretation</label>
<textarea id="interpretation" class="readonly" readonly></textarea>

<label>Observed Findings</label>
<textarea id="observedFindings" class="readonly" readonly></textarea>
</div>

<div class="section" id="signatureBox">
<h2>Reviewer</h2>

<label>Reviewed By</label>
<input type="text" id="reviewerName">

<label>Role</label>
<select id="reviewerRole">
<option value="">Select</option>
<option>CRNA</option>
<option>MD</option>
<option>DO</option>
<option>DDS</option>
<option>RN</option>
<option>Resident</option>
</select>

<label><input type="checkbox" id="reviewed"> Reviewed prior to induction</label>
</div>

<button onclick="generatePDF()">Generate PDF Report</button>

<script>
const images = {};

function loadImage(input, imgId, statusId){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById(imgId).src = e.target.result;
    images[imgId] = e.target.result;
    if(statusId){
      document.getElementById(statusId).textContent = "Complete";
      document.getElementById(statusId).className = "complete";
    }
  };
  reader.readAsDataURL(file);
}

const dentitionData = [
["i2","Upper Dentition"],
["i3","Lower Dentition"],
["i4","Right Molars"],
["i5","Left Molars"],
["i6","Natural Occlusion"]
];

dentitionData.forEach(d=>{
  const div=document.createElement("div");
  div.className="section";
  div.innerHTML=`
    <h3>${d[0].toUpperCase()} — ${d[1]}</h3>
    <input type="file" accept="image/*" onchange="loadImage(this,'${d[0]}Img')">
    <img id="${d[0]}Img" class="preview">
  `;
  document.getElementById("dentition").appendChild(div);
});

function updateClinical(){
  if(!mallampati.value) return;

  const findings=[];
  if(soft.checked) findings.push("Soft palate visible");
  if(uvula.checked) findings.push("Uvula visible");
  if(pillars.checked) findings.push("Faucial pillars visible");
  if(hard.checked) findings.push("Only hard palate visible");

  const high = mallampati.value==="III" || mallampati.value==="IV" || tongueObs.checked;

  airwayRisk.value = high ? "HIGH" : "LOW";

  riskDescription.value = high
    ? "Findings suggest increased difficulty with airway management. Preparation for advanced airway techniques is recommended."
    : "Findings suggest low anticipated difficulty with airway management.";

  interpretation.value =
    `Mallampati ${mallampati.value}` +
    (tongueObs.checked ? " with tongue obstruction noted." : ".");

  observedFindings.value = findings.join("; ");
}

document.querySelectorAll("input,select").forEach(e=>e.addEventListener("change",updateClinical));

async function generatePDF(){
  const session = sessionId.value || "Patient Pending";
  const now = new Date().toLocaleString("en-US",{timeZone:"America/Chicago"});

  const clone = document.body.cloneNode(true);

  const header = document.createElement("div");
  header.innerHTML = `
    <h1>Pre-Operative Dental & Airway Report</h1>
    <strong>Session ID:</strong> ${session}<br>
    <strong>Capture Timestamp (CST):</strong> ${now}<br><br>
  `;
  clone.prepend(header);

  const container = document.createElement("div");
  container.style.background="white";
  container.style.padding="30px";
  container.appendChild(clone);

  document.body.appendChild(container);

  await new Promise(r=>setTimeout(r,500));

  html2pdf().set({
    margin:10,
    filename:`PreOp_${session}.pdf`,
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:"mm",format:"a4"}
  }).from(container).save().then(()=>container.remove());
}
</script>

</body>
</html>
