<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 30px; }
  h1 { margin-bottom: 5px; }
  h2 { margin-top: 40px; }
  .section { margin-bottom: 25px; }
  .complete { color: green; font-weight: bold; }
  img.preview { max-width: 300px; margin-top: 10px; display: block; }
  button { padding: 12px 20px; font-size: 16px; }
</style>
</head>

<body>

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong>

<div class="section">
  <label>Patient / Session ID:
    <input id="sessionId" placeholder="Auto-generated if left blank">
  </label>
</div>

<div class="section">
  <h2>I1 — Airway View</h2>
  <input type="file" accept="image/*" id="img1">
  <div>
    <label><input type="checkbox" id="tongue"> Tongue obstruction noted</label>
    Mallampati:
    <select id="mallampati">
      <option value="">Select</option>
      <option>I</option>
      <option>II</option>
      <option>III</option>
      <option>IV</option>
    </select>
  </div>

  <h3>Mallampati Rationale (Observed)</h3>
  <label><input type="checkbox" id="soft"> Soft palate visible</label><br>
  <label><input type="checkbox" id="uvula"> Uvula visible</label><br>
  <label><input type="checkbox" id="pillars"> Faucial pillars visible</label><br>
  <label><input type="checkbox" id="hardonly"> Only hard palate visible</label>
</div>

<div class="section">
  <h2>I2–I6 Dentition Images</h2>
  <input type="file" accept="image/*" id="img2"><br>
  <input type="file" accept="image/*" id="img3"><br>
  <input type="file" accept="image/*" id="img4"><br>
  <input type="file" accept="image/*" id="img5"><br>
  <input type="file" accept="image/*" id="img6">
</div>

<button onclick="generatePDF()">Generate PDF Report</button>

<script>
function formatCST() {
  const d = new Date();
  return d.toLocaleString("en-US", {
    timeZone: "America/Chicago",
    month: "short",
    day: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  }) + " CST";
}

async function addImage(doc, file, y) {
  if (!file) return y;
  const data = await new Promise(r => {
    const reader = new FileReader();
    reader.onload = () => r(reader.result);
    reader.readAsDataURL(file);
  });
  doc.addImage(data, "JPEG", 20, y, 170, 100);
  return y + 110;
}

async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 20;
  const sid = document.getElementById("sessionId").value || "SESSION-" + Date.now();

  doc.setFontSize(18);
  doc.text("Pre-Operative Dental & Airway Report", 20, y); y += 10;

  doc.setFontSize(11);
  doc.text(`Session ID: ${sid}`, 20, y); y += 7;
  doc.text(`Capture Timestamp (CST): ${formatCST()}`, 20, y); y += 10;

  // === AIRWAY DATA ===
  doc.setFontSize(13);
  doc.text("Airway Assessment", 20, y); y += 8;

  doc.setFontSize(11);
  doc.text(`Mallampati Class: ${mallampati.value}`, 20, y); y += 6;
  doc.text(`Tongue Obstruction: ${tongue.checked ? "Yes" : "No"}`, 20, y); y += 8;

  doc.text("Mallampati Rationale:", 20, y); y += 6;
  doc.text(`Soft palate visible: ${soft.checked ? "Yes" : "No"}`, 25, y); y += 5;
  doc.text(`Uvula visible: ${uvula.checked ? "Yes" : "No"}`, 25, y); y += 5;
  doc.text(`Faucial pillars visible: ${pillars.checked ? "Yes" : "No"}`, 25, y); y += 5;
  doc.text(`Only hard palate visible: ${hardonly.checked ? "Yes" : "No"}`, 25, y); y += 10;

  // === RISK ASSESSMENT — FIXED & LOCKED ===
  doc.setFontSize(13);
  doc.text("Airway Risk Stratification (Rules-Based):", 20, y); y += 8;

  const risk =
    (mallampati.value === "III" || mallampati.value === "IV" || tongue.checked)
      ? "MODERATE"
      : "LOW";

  doc.setFontSize(11);
  doc.text(risk, 25, y); y += 8;

  doc.text("Clinical Considerations (Non-Diagnostic):", 20, y); y += 6;
  doc.text(
    risk === "MODERATE"
      ? "Findings may increase airway management complexity."
      : "No increased airway complexity identified.",
    25, y
  );

  // === IMAGES START ON PAGE 2 ===
  doc.addPage();
  y = 20;

  y = await addImage(doc, img1.files[0], y);
  y = await addImage(doc, img2.files[0], y);
  y = await addImage(doc, img3.files[0], y);
  y = await addImage(doc, img4.files[0], y);
  y = await addImage(doc, img5.files[0], y);
  y = await addImage(doc, img6.files[0], y);

  doc.save(`PreOp_${sid}.pdf`);
}
</script>

</body>
</html>
