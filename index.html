<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { max-width:1000px; margin:auto; background:#fff; padding:30px; border-radius:10px; }
.section { border-top:1px solid #ddd; margin-top:30px; padding-top:20px; }
.preview { max-width:240px; display:block; margin:10px 0; border:1px solid #ccc; }
label { display:block; margin:6px 0; }
button { padding:16px 24px; font-size:18px; margin-top:40px; cursor:pointer; }
.captured { color:green; font-weight:bold; margin-left:8px; }
</style>
</head>

<body>
<div class="container">
<h1>Pre-Operative Dental & Airway Capture System</h1>

<label>
Patient / Session ID:
<input type="text" id="sessionId" placeholder="Auto-generated if left blank">
</label>

<!-- AIRWAY -->
<div class="section">
<h2>I1 – Airway View <span id="cap_I1"></span></h2>
<input type="file" id="airwayImage" accept="image/*">
<img id="airwayPreview" class="preview">

<label><input type="checkbox" id="tongueObstruction"> Tongue obstruction noted</label>

<label>Mallampati Class:
<select id="mallampati">
<option value="">Select</option>
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>
</label>

<h3>Mallampati Rationale</h3>
<label><input type="checkbox" id="softPalate"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hardPalate"> Only hard palate visible</label>
</div>

<!-- DENTITION -->
<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<button onclick="generatePDF()">Generate PDF Report</button>
</div>

<script>
const dentitionViews = [
  { id:"I2", label:"Upper Dentition" },
  { id:"I3", label:"Lower Dentition" },
  { id:"I4", label:"Right Molars" },
  { id:"I5", label:"Left Molars" },
  { id:"I6", label:"Natural Occlusion" }
];

const dentDiv = document.getElementById("dentition");

dentitionViews.forEach(v=>{
  dentDiv.innerHTML += `
  <div class="section">
    <h3>${v.id} – ${v.label} <span id="cap_${v.id}"></span></h3>
    <input type="file" id="${v.id}img" accept="image/*">
    <img id="${v.id}prev" class="preview">

    <label><input type="checkbox" id="${v.id}missing"> Missing teeth</label>
    <label><input type="checkbox" id="${v.id}crowns"> Crowns / restorations</label>
    <label><input type="checkbox" id="${v.id}chips"> Chips / fractures</label>
    ${v.id==="I6" ? `<label><input type="checkbox" id="${v.id}occlusion"> Occlusal instability</label>` : ""}
  </div>`;
});

function bindPreview(inputId, imgId, capId){
  const input=document.getElementById(inputId);
  const img=document.getElementById(imgId);
  const cap=document.getElementById(capId);
  input.onchange=()=>{
    if(input.files[0]){
      img.src=URL.createObjectURL(input.files[0]);
      cap.innerHTML="✓ Captured";
      cap.className="captured";
    }
  };
}

bindPreview("airwayImage","airwayPreview","cap_I1");
dentitionViews.forEach(v=>bindPreview(v.id+"img",v.id+"prev","cap_"+v.id));

function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF();
  let y=15;

  let sid=document.getElementById("sessionId").value.trim();
  if(!sid) sid="SID-"+Date.now();
  const ts=new Date().toISOString();

  const mall=mallampati.value;
  const tongue=tongueObstruction.checked;

  let risk="LOW";
  if(mall==="III"||mall==="IV"||tongue) risk="MODERATE";
  if(mall==="IV"&&tongue) risk="HIGH";

  let reason=[];
  if(tongue) reason.push("tongue obstruction");
  if(mall==="III"||mall==="IV") reason.push("limited oropharyngeal visualization");

  const compositeSentence =
    reason.length
    ? `This risk stratification reflects ${reason.join(" and ")}, which may increase airway management complexity.`
    : "No significant airway visualization limitations were observed based on captured inputs.";

  pdf.setFontSize(16);
  pdf.text("Pre-Operative Dental & Airway Report",10,y); y+=8;
  pdf.setFontSize(10);
  pdf.text(`Session ID: ${sid}`,10,y); y+=5;
  pdf.text(`Timestamp (UTC): ${ts}`,10,y); y+=8;

  pdf.setFontSize(12);
  pdf.text(`Mallampati Class: ${mall||"Not selected"}`,10,y); y+=6;
  pdf.text(`Tongue Obstruction: ${tongue?"Yes":"No"}`,10,y); y+=6;
  pdf.text(`Airway Risk Stratification (Rules-Based): ${risk}`,10,y); y+=8;

  pdf.text("Clinical Considerations (Non-Diagnostic):",10,y); y+=6;
  pdf.text(compositeSentence,12,y,{maxWidth:180}); y+=12;

  pdf.text("Patent Pending",10,290);
  pdf.save(`PreOp_Report_${sid}.pdf`);
}
</script>
</body>
</html>
