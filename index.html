<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pre-Operative Dental & Airway Capture System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { max-width:1000px; margin:auto; background:#fff; padding:30px; border-radius:10px; }
.section { border-top:1px solid #ddd; margin-top:30px; padding-top:20px; }
.preview { max-width:260px; display:block; margin:10px 0; border:1px solid #ccc; }
label { display:block; margin:6px 0; }
h2,h3 { margin-bottom:10px; }
button { padding:16px 24px; font-size:18px; margin-top:40px; cursor:pointer; }
.status { font-weight:bold; margin-left:10px; }
.complete { color:green; }
.incomplete { color:#999; }
</style>
</head>

<body>
<div class="container">

<h1>Pre-Operative Dental & Airway Capture System</h1>

<label>
Patient / Session ID:
<input id="sessionId" placeholder="Auto-generated if left blank" />
</label>

<!-- AIRWAY -->
<div class="section">
<h2>I1 — Airway View <span id="status-I1" class="status incomplete">Incomplete</span></h2>
<input type="file" id="I1img" accept="image/*" />
<img id="I1prev" class="preview" />

<label><input type="checkbox" id="tongue"> Tongue obstruction noted</label>

<label>Mallampati Class:
<select id="mallampati">
<option value="">Select</option>
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>
</label>

<h3>Mallampati Rationale (Observed)</h3>
<label><input type="checkbox" id="softPalate"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hardPalate"> Only hard palate visible</label>
</div>

<!-- DENTITION -->
<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<button id="generateBtn" disabled>Generate PDF Report</button>

</div>

<script>
const dentitionViews = [
 {id:"I2",label:"Upper Dentition"},
 {id:"I3",label:"Lower Dentition"},
 {id:"I4",label:"Right Molars"},
 {id:"I5",label:"Left Molars"},
 {id:"I6",label:"Natural Occlusion", occlusion:true}
];

const imageData = {};

function readImage(input, id){
 const file = input.files[0];
 if(!file) return;
 const reader = new FileReader();
 reader.onload = e => {
   imageData[id] = e.target.result;
   document.getElementById(id+"prev").src = e.target.result;
   document.getElementById("status-"+id).textContent = "Complete";
   document.getElementById("status-"+id).className = "status complete";
   validate();
 };
 reader.readAsDataURL(file);
}

readImage(document.getElementById("I1img"), "I1");

dentitionViews.forEach(v=>{
 document.getElementById("dentition").insertAdjacentHTML("beforeend",`
 <div class="section">
 <h3>${v.id} — ${v.label} <span id="status-${v.id}" class="status incomplete">Incomplete</span></h3>
 <input type="file" id="${v.id}img" accept="image/*" />
 <img id="${v.id}prev" class="preview" />
 <label><input type="checkbox" id="${v.id}missing"> Missing teeth</label>
 <label><input type="checkbox" id="${v.id}crowns"> Crowns / restorations</label>
 <label><input type="checkbox" id="${v.id}chips"> Chips / fractures</label>
 ${v.occlusion?`<label><input type="checkbox" id="${v.id}occlusion"> Occlusal instability noted</label>`:""}
 </div>
 `);
 document.getElementById(v.id+"img").addEventListener("change",e=>readImage(e.target,v.id));
});

function validate(){
 const required = ["I1","I2","I3","I4","I5","I6"];
 document.getElementById("generateBtn").disabled =
   !required.every(k=>imageData[k]);
}

function getCST(){
 const d = new Date();
 return d.toLocaleString("en-US", {
   timeZone:"America/Chicago",
   month:"short", day:"2-digit", year:"numeric",
   hour:"2-digit", minute:"2-digit", hour12:true
 })+" CST";
}

document.getElementById("generateBtn").onclick = () => {
 const { jsPDF } = window.jspdf;
 const pdf = new jsPDF();
 let y=15;

 const sid = sessionId.value || "SESSION-"+Date.now();
 const mall = mallampati.value;
 const tongueObs = tongue.checked;

 let risk="LOW";
 if(mall==="III"||mall==="IV"||tongueObs) risk="MODERATE";
 if(mall==="IV"&&tongueObs) risk="HIGH";

 pdf.setFontSize(18);
 pdf.text("Pre-Operative Dental & Airway Report",10,y); y+=10;

 pdf.setFontSize(12);
 pdf.text(`Session ID: ${sid}`,10,y); y+=6;
 pdf.text(`Capture Timestamp (CST): ${getCST()}`,10,y); y+=8;

 pdf.text(`Mallampati Class: ${mall}`,10,y); y+=6;
 pdf.text(`Tongue Obstruction: ${tongueObs?"Yes":"No"}`,10,y); y+=6;

 pdf.text(`Airway Risk Stratification (Rules-Based): ${risk}`,10,y); y+=8;

 pdf.text("Clinical Considerations (Non-Diagnostic):",10,y); y+=6;
 pdf.text(
  risk==="HIGH"
   ?"High-risk airway indicators present; anticipate difficult airway management."
   :risk==="MODERATE"
   ?"Moderate airway complexity noted; increased vigilance advised."
   :"No elevated airway risk indicators identified.",
 10,y,{maxWidth:180}); y+=10;

 pdf.text("Mallampati Rationale:",10,y); y+=6;
 pdf.text(`Soft palate visible: ${softPalate.checked?"Yes":"No"}`,14,y); y+=5;
 pdf.text(`Uvula visible: ${uvula.checked?"Yes":"No"}`,14,y); y+=5;
 pdf.text(`Faucial pillars visible: ${pillars.checked?"Yes":"No"}`,14,y); y+=5;
 pdf.text(`Only hard palate visible: ${hardPalate.checked?"Yes":"No"}`,14,y); y+=8;

 pdf.addImage(imageData.I1,"JPEG",10,y,80,80);
 pdf.text("I1 — Airway View",100,y+5);
 pdf.addPage(); y=15;

 dentitionViews.forEach(v=>{
  pdf.text(`${v.id} — ${v.label}`,10,y); y+=6;
  pdf.addImage(imageData[v.id],"JPEG",10,y,80,80);
  pdf.text(`Missing teeth: ${document.getElementById(v.id+"missing").checked?"Yes":"No"}`,100,y+10);
  pdf.text(`Crowns/restorations: ${document.getElementById(v.id+"crowns").checked?"Yes":"No"}`,100,y+16);
  pdf.text(`Chips/fractures: ${document.getElementById(v.id+"chips").checked?"Yes":"No"}`,100,y+22);
  if(v.occlusion)
   pdf.text(`Occlusal instability: ${document.getElementById(v.id+"occlusion").checked?"Yes":"No"}`,100,y+28);
  y+=95;
  if(y>240){ pdf.addPage(); y=15; }
 });

 const pages = pdf.getNumberOfPages();
 for(let i=1;i<=pages;i++){
  pdf.setPage(i);
  pdf.setFontSize(9);
  pdf.text("Patent Pending",105,290,{align:"center"});
 }

 pdf.save(`PreOp_${sid}.pdf`);
};
</script>

</body>
</html>
