<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pre-Operative Dental & Airway Capture System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { max-width:1000px; margin:auto; background:#fff; padding:30px; border-radius:10px; }
.section { border-top:1px solid #ddd; margin-top:30px; padding-top:20px; }
.preview { max-width:260px; display:block; margin:10px 0; border:1px solid #ccc; }
.complete { color:#2e7d32; font-weight:bold; margin-left:10px; }
button { padding:16px 24px; font-size:18px; margin-top:40px; cursor:pointer; }
button:disabled { opacity:0.4; cursor:not-allowed; }
h1,h2,h3 { margin-bottom:10px; }
label { display:block; margin:6px 0; }
.small { font-size:12px; color:#666; }
</style>
</head>

<body>
<div class="container">

<h1>Pre-Operative Dental & Airway Capture System</h1>
<div class="small"><strong>Patent Pending</strong></div>

<label>
Patient / Session ID:
<input id="sessionId" placeholder="Auto-generated if left blank" />
</label>

<!-- I1 AIRWAY -->
<div class="section">
<h2>I1 — Airway View <span id="I1status"></span></h2>
<input type="file" id="I1file" accept="image/*">
<img id="I1preview" class="preview">

<label><input type="checkbox" id="tongueObstruction"> Tongue obstruction noted</label>

<label>Mallampati Class:
<select id="mallampati">
<option value="">Select</option>
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>
</label>

<h3>Mallampati Rationale (Observed)</h3>
<label><input type="checkbox" id="softPalate"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hardPalate"> Only hard palate visible</label>
</div>

<!-- DENTITION -->
<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<button id="generateBtn" disabled>Generate PDF Report</button>

</div>

<script>
const dentitionViews = [
  { id:"I2", label:"Upper Dentition" },
  { id:"I3", label:"Lower Dentition" },
  { id:"I4", label:"Right Molars" },
  { id:"I5", label:"Left Molars" },
  { id:"I6", label:"Natural Occlusion", occlusion:true }
];

const dentDiv = document.getElementById("dentition");

dentitionViews.forEach(v => {
  dentDiv.insertAdjacentHTML("beforeend", `
    <div class="section">
      <h3>${v.id} — ${v.label} <span id="${v.id}status"></span></h3>
      <input type="file" id="${v.id}file" accept="image/*">
      <img id="${v.id}preview" class="preview">

      <label><input type="checkbox" id="${v.id}missing"> Missing teeth</label>
      <label><input type="checkbox" id="${v.id}crowns"> Crowns / restorations</label>
      <label><input type="checkbox" id="${v.id}chips"> Chips / fractures</label>
      ${v.occlusion ? `<label><input type="checkbox" id="${v.id}occlusion"> Occlusal instability noted</label>` : ""}
    </div>
  `);
});

const allIds = ["I1", ...dentitionViews.map(v=>v.id)];

function updateStatus(id) {
  const file = document.getElementById(id+"file").files[0];
  const status = document.getElementById(id+"status");
  status.innerHTML = file ? `<span class="complete">Complete</span>` : "";
  validateReady();
}

function validateReady() {
  const ready = allIds.every(id => document.getElementById(id+"file").files.length);
  document.getElementById("generateBtn").disabled = !ready;
}

async function fileToJPEG(file) {
  return new Promise(res => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement("canvas");
        c.width = img.width;
        c.height = img.height;
        c.getContext("2d").drawImage(img,0,0);
        res(c.toDataURL("image/jpeg",0.9));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

allIds.forEach(id => {
  document.getElementById(id+"file").addEventListener("change", async e => {
    if(e.target.files[0]) {
      document.getElementById(id+"preview").src = URL.createObjectURL(e.target.files[0]);
      updateStatus(id);
    }
  });
});

document.getElementById("generateBtn").onclick = async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const sid = sessionId.value || "SESSION-" + Date.now();
  const now = new Date();
  const cst = now.toLocaleString("en-US", {
    timeZone: "America/Chicago",
    month: "short", day:"2-digit", year:"numeric",
    hour:"2-digit", minute:"2-digit"
  }) + " CST";

  let y = 15;
  pdf.setFontSize(18);
  pdf.text("Pre-Operative Dental & Airway Report",10,y); y+=10;

  pdf.setFontSize(12);
  pdf.text(`Session ID: ${sid}`,10,y); y+=6;
  pdf.text(`Capture Timestamp (CST): ${cst}`,10,y); y+=8;

  pdf.text(`Mallampati Class: ${mallampati.value || "Not selected"}`,10,y); y+=6;
  pdf.text(`Tongue Obstruction: ${tongueObstruction.checked?"Yes":"No"}`,10,y); y+=6;

  pdf.text("Mallampati Rationale:",10,y); y+=6;
  pdf.text(`Soft palate visible: ${softPalate.checked?"Yes":"No"}`,14,y); y+=5;
  pdf.text(`Uvula visible: ${uvula.checked?"Yes":"No"}`,14,y); y+=5;
  pdf.text(`Faucial pillars visible: ${pillars.checked?"Yes":"No"}`,14,y); y+=5;
  pdf.text(`Only hard palate visible: ${hardPalate.checked?"Yes":"No"}`,14,y); y+=10;

  for(const id of allIds) {
    pdf.addPage();
    pdf.text(`${id} — ${id==="I1"?"Airway View":dentitionViews.find(v=>v.id===id)?.label}`,10,15);
    const data = await fileToJPEG(document.getElementById(id+"file").files[0]);
    pdf.addImage(data,"JPEG",10,25,180,120);
  }

  pdf.setFontSize(10);
  pdf.text("Patent Pending",10,285);

  pdf.save(`PreOp_${sid}.pdf`);
};
</script>

</body>
</html>
