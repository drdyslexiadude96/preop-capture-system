<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin:30px; }
h1 { font-size:34px; }
h2 { margin-top:30px; }
.section { margin-bottom:30px; border-bottom:1px solid #ccc; padding-bottom:20px; }
.complete { color:green; font-weight:bold; }
.incomplete { color:red; font-weight:bold; }
img.preview { max-width:250px; display:block; margin-top:10px; border:1px solid #ccc; }
label { display:block; margin:5px 0; }
button { padding:10px 18px; font-size:16px; margin-top:20px; }
input[type=text], select { padding:6px; width:260px; }
.hidden { display:none; }
</style>
</head>

<body>

<div id="pdfRoot">

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong><br><br>

<label>
Patient / Session ID:
<input type="text" id="sessionId" value="Patient Pending">
</label>

<!-- ================= AIRWAY ================= -->
<div class="section">
<h2>I1 — Airway View <span id="i1Status" class="incomplete">Incomplete</span></h2>

<input type="file" accept="image/*" onchange="loadImage(this,'airwayImg','i1Status')">
<img id="airwayImg" class="preview">

<label>Mallampati:
<select id="mallampati">
<option value="">Select</option>
<option value="I">I</option>
<option value="II">II</option>
<option value="III">III</option>
<option value="IV">IV</option>
</select>
</label>

<label><input type="checkbox" id="tongueObs"> Tongue obstruction noted</label>

<strong>Mallampati Rationale (Observed)</strong>
<label><input type="checkbox" id="soft"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hard"> Only hard palate visible</label>
</div>

<!-- ================= DENTITION ================= -->
<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<!-- ================= CLINICAL ================= -->
<div class="section" id="clinicalBox">
<h2>Clinical Interpretation</h2>
<div id="clinicalText">Complete airway inputs to generate interpretation.</div>
</div>

<!-- ================= SIGNATURE ================= -->
<div class="section" id="signatureBox">
<h2>Reviewer</h2>

<label>
Reviewed by:
<input type="text" id="reviewerName">
</label>

<label>
Role:
<select id="reviewerRole">
<option value="">Select</option>
<option>CRNA</option>
<option>MD</option>
<option>DDS</option>
<option>RN</option>
<option>PA</option>
</select>
</label>

<label>
<input type="checkbox" id="reviewed"> Reviewed prior to induction
</label>
</div>

</div>

<button id="pdfBtn" onclick="generatePDF()">Generate PDF Report</button>

<script>
const images = {};

function loadImage(input, imgId, statusId) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById(imgId).src = e.target.result;
    images[imgId] = e.target.result;
    if (statusId) {
      document.getElementById(statusId).textContent = "Complete";
      document.getElementById(statusId).className = "complete";
    }
  };
  reader.readAsDataURL(file);
}

const dentitionData = [
  ["i2","Upper Dentition"],
  ["i3","Lower Dentition"],
  ["i4","Right Molars"],
  ["i5","Left Molars"],
  ["i6","Natural Occlusion"]
];

dentitionData.forEach(d=>{
  const div=document.createElement("div");
  div.className="section";
  div.innerHTML=`
  <h3>${d[0].toUpperCase()} — ${d[1]} <span id="${d[0]}Status" class="incomplete">Incomplete</span></h3>
  <input type="file" accept="image/*" onchange="loadImage(this,'${d[0]}Img','${d[0]}Status')">
  <img id="${d[0]}Img" class="preview">
  <label><input type="checkbox"> Missing teeth</label>
  <label><input type="checkbox"> Crowns / restorations</label>
  <label><input type="checkbox"> Chips / fractures</label>
  `;
  document.getElementById("dentition").appendChild(div);
});

function updateClinical(){
  const m = mallampati.value;
  if(!m) return;

  let risk="LOW";
  if(m==="III"||m==="IV"||tongueObs.checked) risk="HIGH";

  let findings=[];
  if(soft.checked) findings.push("Soft palate visible");
  if(uvula.checked) findings.push("Uvula visible");
  if(pillars.checked) findings.push("Faucial pillars visible");
  if(hard.checked) findings.push("Only hard palate visible");

  clinicalText.innerHTML=`
  <strong>Airway Risk:</strong> ${risk}<br>
  <strong>Interpretation:</strong> Mallampati ${m}${tongueObs.checked?" with tongue obstruction noted.":"."}<br>
  <strong>Observed Findings:</strong><br>${findings.join("<br>")}
  `;
}
document.querySelectorAll("input,select").forEach(e=>e.addEventListener("change",updateClinical));

function generatePDF(){
  document.getElementById("pdfBtn").classList.add("hidden");

  const now = new Date().toLocaleString("en-US",{timeZone:"America/Chicago"});
  const stamp = document.createElement("div");
  stamp.innerHTML = `<strong>Capture Timestamp (CST):</strong> ${now}<br><br>`;
  pdfRoot.insertBefore(stamp, pdfRoot.firstChild);

  html2pdf().set({
    margin:10,
    filename:`PreOp_${sessionId.value || "Patient"}.pdf`,
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:"mm",format:"a4"}
  }).from(pdfRoot).save().then(()=>{
    stamp.remove();
    document.getElementById("pdfBtn").classList.remove("hidden");
  });
}
</script>

</body>
</html>
