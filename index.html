<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pre-Operative Capture & Analysis System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#eef2f7;
  padding:2rem;
}
.card {
  max-width:960px;
  margin:auto;
  background:#fff;
  padding:2.5rem;
  border-radius:14px;
  box-shadow:0 12px 40px rgba(0,0,0,.12);
}
h1,h2,h3 { margin-top:0; }
.progress {
  height:14px;
  background:#ddd;
  border-radius:7px;
  margin:1rem 0 2rem;
}
.progress div {
  height:100%;
  background:#22c55e;
  border-radius:7px;
}
img {
  max-width:100%;
  margin-top:1rem;
  border-radius:10px;
  border:1px solid #ccc;
}
button {
  margin-top:1.5rem;
  padding:.9rem 1.6rem;
  border:none;
  border-radius:10px;
  background:#4f46e5;
  color:#fff;
  font-size:1rem;
  cursor:pointer;
}
.secondary { background:#334155; }
.section {
  border:1px solid #ddd;
  padding:1rem;
  border-radius:10px;
  margin-top:1.5rem;
}
label { display:block; margin:.4rem 0; }
select { margin-top:.4rem; }
</style>
</head>

<body>
<div class="card" id="app"></div>

<script>
const { jsPDF } = window.jspdf;

const steps = [
  { id:"I1", name:"Airway View", desc:"Mouth open, tongue protruded, patient upright" },
  { id:"I2", name:"Upper Dentition", desc:"Frontal view of maxillary teeth" },
  { id:"I3", name:"Lower Dentition", desc:"Frontal view of mandibular teeth" },
  { id:"I4", name:"Right Molars", desc:"Right posterior dentition" },
  { id:"I5", name:"Left Molars", desc:"Left posterior dentition" },
  { id:"I6", name:"Natural Occlusion", desc:"Frontal bite with teeth in contact" }
];

let index = 0;
let images = [];
let analysis = {};

const app = document.getElementById("app");

function renderCapture() {
  app.innerHTML = `
    <h1>Pre-Operative Capture System</h1>
    <div class="progress"><div style="width:${(index/6)*100}%"></div></div>
    <h2>${steps[index].id} â€“ ${steps[index].name}</h2>
    <p>${steps[index].desc}</p>
    <input type="file" id="file" accept="image/*" />
    <img id="preview" style="display:none" />
    <button id="next" disabled>Next Capture</button>
  `;

  const file = document.getElementById("file");
  const preview = document.getElementById("preview");
  const next = document.getElementById("next");

  file.onchange = () => {
    const r = new FileReader();
    r.onload = e => {
      images.push(e.target.result);
      preview.src = e.target.result;
      preview.style.display = "block";
      next.disabled = false;
    };
    r.readAsDataURL(file.files[0]);
  };

  next.onclick = () => {
    index++;
    index < 6 ? renderCapture() : renderAnalysis();
  };
}

function renderAnalysis() {
  app.innerHTML = `
    <h1>Clinical Analysis</h1>

    ${steps.map((s,i)=>`
      <div class="section">
        <h3>${s.id} â€“ ${s.name}</h3>
        <img src="${images[i]}" />

        ${s.id==="I1" ? `
          <label>Mallampati Class:
            <select onchange="save('${s.id}','mallampati',this.value)">
              <option></option><option>I</option><option>II</option><option>III</option><option>IV</option>
            </select>
          </label>
          <label><input type="checkbox" onchange="save('${s.id}','tongue',this.checked)"> Tongue obstruction noted</label>
        ` : s.id==="I6" ? `
          <label><input type="checkbox" onchange="save('${s.id}','malocclusion',this.checked)"> Occlusal instability</label>
        ` : `
          <label><input type="checkbox" onchange="save('${s.id}','missing',this.checked)"> Missing teeth</label>
          <label><input type="checkbox" onchange="save('${s.id}','crowns',this.checked)"> Crowns / restorations</label>
          <label><input type="checkbox" onchange="save('${s.id}','chips',this.checked)"> Chips / fractures</label>
        `}
      </div>
    `).join("")}

    <button class="secondary" onclick="generatePDF()">ðŸ“„ Generate PDF Report</button>
  `;
}

function save(step,key,val){
  if(!analysis[step]) analysis[step]={};
  analysis[step][key]=val;
}

function generatePDF(){
  const pdf = new jsPDF();
  let y = 15;

  pdf.setFontSize(16);
  pdf.text("Pre-Operative Capture Report",10,y); y+=10;
  pdf.setFontSize(10);
  pdf.text(`Generated: ${new Date().toLocaleString()}`,10,y); y+=10;

  steps.forEach((s,i)=>{
    pdf.text(`${s.id} â€“ ${s.name}`,10,y); y+=6;
    pdf.addImage(images[i],"JPEG",10,y,60,45);
    y+=50;
    Object.entries(analysis[s.id]||{}).forEach(([k,v])=>{
      pdf.text(`â€¢ ${k}: ${v}`,10,y); y+=5;
    });
    if(y>260){ pdf.addPage(); y=15; }
  });

  pdf.text("Disclaimer: Structured screening only. Clinical judgment required.",10,y+10);
  pdf.save("PreOp_Report.pdf");
}

renderCapture();
</script>
</body>
</html>
