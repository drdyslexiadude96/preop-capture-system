<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin:30px; }
h1 { font-size:34px; }
h2 { margin-top:30px; }
.section { margin-bottom:30px; border-bottom:1px solid #ccc; padding-bottom:20px; }
.complete { color:green; font-weight:bold; }
.incomplete { color:red; font-weight:bold; }
img.preview { max-width:250px; display:block; margin-top:10px; border:1px solid #ccc; }
button { padding:10px 18px; font-size:16px; margin-top:20px; }
label { display:block; margin:5px 0; }
</style>
</head>

<body>

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong><br><br>

<label>
Patient / Session ID:
<input type="text" id="sessionId" placeholder="Patient Pending">
</label>

<!-- ================= AIRWAY VIEW ================= -->
<div class="section">
<h2>I1 — Airway View <span id="i1Status" class="incomplete">Incomplete</span></h2>

<input type="file" accept="image/*" onchange="handleImage(this,'airwayImg','i1Status')">
<img id="airwayImg" class="preview">

<label>Mallampati:
<select id="mallampati">
<option value="">Select</option>
<option value="I">I</option>
<option value="II">II</option>
<option value="III">III</option>
<option value="IV">IV</option>
</select>
</label>

<label><input type="checkbox" id="tongueObs"> Tongue obstruction noted</label>

<strong>Mallampati Rationale (Observed)</strong>
<label><input type="checkbox" id="soft"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hard"> Only hard palate visible</label>
</div>

<!-- ================= DENTITION ================= -->
<div class="section">
<h2>Dentition Images</h2>

<script>
const dentition = [
["i2","Upper Dentition"],
["i3","Lower Dentition"],
["i4","Right Molars"],
["i5","Left Molars"],
["i6","Natural Occlusion"]
];
</script>

<div id="dentitionBlocks"></div>
</div>

<!-- ================= CLINICAL INTERPRETATION ================= -->
<div class="section" id="interpretationBox">
<h2>Clinical Interpretation</h2>
<div id="interpretationText">Complete airway inputs to generate interpretation.</div>
</div>

<button onclick="generatePDF()">Generate PDF Report</button>

<!-- ================= SCRIPT ================= -->
<script>
const images = {};

function handleImage(input,imgId,statusId){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    document.getElementById(imgId).src = e.target.result;
    images[imgId] = e.target.result;
    if(statusId){
      document.getElementById(statusId).textContent = "Complete";
      document.getElementById(statusId).className = "complete";
    }
  };
  reader.readAsDataURL(file);
}

dentition.forEach(d=>{
  const div=document.createElement("div");
  div.className="section";
  div.innerHTML=`
  <h3>${d[0].toUpperCase()} — ${d[1]} <span id="${d[0]}Status" class="incomplete">Incomplete</span></h3>
  <input type="file" accept="image/*" onchange="handleImage(this,'${d[0]}Img','${d[0]}Status')">
  <img id="${d[0]}Img" class="preview">
  <label><input type="checkbox"> Missing teeth</label>
  <label><input type="checkbox"> Crowns / restorations</label>
  <label><input type="checkbox"> Chips / fractures</label>
  `;
  document.getElementById("dentitionBlocks").appendChild(div);
});

function updateInterpretation(){
  const m=document.getElementById("mallampati").value;
  if(!m) return;

  let risk="LOW";
  if(m==="III"||m==="IV") risk="HIGH";
  if(document.getElementById("tongueObs").checked) risk="HIGH";

  let findings=[];
  if(soft.checked) findings.push("Soft palate visible");
  if(uvula.checked) findings.push("Uvula visible");
  if(pillars.checked) findings.push("Faucial pillars visible");
  if(hard.checked) findings.push("Only hard palate visible");

  document.getElementById("interpretationText").innerHTML=`
  <strong>Airway Risk:</strong> ${risk}<br>
  <strong>Interpretation:</strong> Mallampati ${m}${tongueObs.checked?" with tongue obstruction noted.":"."}<br>
  <strong>Observed Findings:</strong><br>${findings.join("<br>")}
  `;
}
document.querySelectorAll("input,select").forEach(e=>e.addEventListener("change",updateInterpretation));

function generatePDF(){
  const now=new Date().toLocaleString("en-US",{timeZone:"America/Chicago"});
  const session=document.getElementById("sessionId").value||"Patient Pending";

  const pdf=document.createElement("div");
  pdf.innerHTML=`
  <h1>Pre-Operative Dental & Airway Report</h1>
  <strong>Session ID:</strong> ${session}<br>
  <strong>Capture Timestamp (CST):</strong> ${now}<br><br>
  ${document.getElementById("interpretationBox").innerHTML}
  `;

  Object.keys(images).forEach(k=>{
    const img=document.createElement("img");
    img.src=images[k];
    img.style.maxWidth="250px";
    pdf.appendChild(img);
  });

  html2pdf().set({
    margin:10,
    filename:`PreOp_${session}.pdf`,
    html2canvas:{scale:2},
    jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
  }).from(pdf).save();
}
</script>

</body>
</html>
