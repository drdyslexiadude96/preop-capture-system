<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { max-width:1000px; margin:auto; background:#fff; padding:30px; border-radius:10px; }
.section { border-top:1px solid #ddd; margin-top:30px; padding-top:20px; }
.preview { max-width:240px; display:block; margin:10px 0; border:1px solid #ccc; }
.complete { color:green; font-weight:bold; margin-left:10px; }
button { padding:16px 24px; font-size:18px; margin-top:40px; }
button:disabled { opacity:0.4; }
.subtitle { font-weight:bold; margin-top:5px; }
</style>
</head>

<body>
<div class="container">

<h1>Pre-Operative Dental & Airway Capture System</h1>
<div class="subtitle">Patent Pending</div>

<p><strong>Patient / Session ID:</strong>
<input id="sessionId" placeholder="Auto-generated if left blank">
</p>

<!-- AIRWAY -->
<div class="section">
<h2>I1 — Airway View <span id="status-I1"></span></h2>
<input type="file" id="I1" accept="image/*">
<img id="prev-I1" class="preview">

<label><input type="checkbox" id="tongue"> Tongue obstruction noted</label>

<label>Mallampati Class:
<select id="mall">
<option value="">Select</option>
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>
</label>

<h3>Mallampati Rationale (Observed)</h3>
<label><input type="checkbox" id="softPalate"> Soft palate visible</label><br>
<label><input type="checkbox" id="uvula"> Uvula visible</label><br>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label><br>
<label><input type="checkbox" id="hardPalate"> Only hard palate visible</label>
</div>

<!-- DENTITION -->
<div class="section"><h2>Dentition Images</h2></div>
<div id="dentition"></div>

<button id="generate" disabled>Generate PDF Report</button>
</div>

<script>
const views = [
 {id:"I2",label:"Upper Dentition"},
 {id:"I3",label:"Lower Dentition"},
 {id:"I4",label:"Right Molars"},
 {id:"I5",label:"Left Molars"},
 {id:"I6",label:"Natural Occlusion"}
];

const dentDiv = document.getElementById("dentition");

views.forEach(v=>{
 dentDiv.insertAdjacentHTML("beforeend",`
 <div class="section">
 <h3>${v.id} — ${v.label} <span id="status-${v.id}"></span></h3>
 <input type="file" id="${v.id}" accept="image/*">
 <img id="prev-${v.id}" class="preview">
 </div>
 `);
});

const allIds = ["I1", ...views.map(v=>v.id)];
const imgData = {};

function toBase64(file){
 return new Promise(res=>{
  const r = new FileReader();
  r.onload = ()=>res(r.result);
  r.readAsDataURL(file);
 });
}

allIds.forEach(id=>{
 document.getElementById(id).addEventListener("change", async e=>{
  const f = e.target.files[0];
  if(!f) return;
  imgData[id] = await toBase64(f);
  document.getElementById("prev-"+id).src = imgData[id];
  document.getElementById("status-"+id).textContent = "Complete";
  document.getElementById("status-"+id).className = "complete";
  validate();
 });
});

function validate(){
 document.getElementById("generate").disabled =
  allIds.some(id=>!imgData[id]);
}

document.getElementById("generate").onclick = ()=>{
 const { jsPDF } = window.jspdf;
 const pdf = new jsPDF();
 let y = 20;

 const sid = document.getElementById("sessionId").value || "AUTO-"+Date.now();

 const ts = new Intl.DateTimeFormat("en-US",{
  timeZone:"America/Chicago",
  dateStyle:"medium",
  timeStyle:"short"
 }).format(new Date());

 pdf.setFontSize(18);
 pdf.text("Pre-Operative Dental & Airway Report",10,y); y+=10;

 pdf.setFontSize(12);
 pdf.text(`Session ID: ${sid}`,10,y); y+=6;
 pdf.text(`Capture Timestamp (CST): ${ts}`,10,y); y+=10;

 pdf.text(`Mallampati Class: ${mall.value || "Not selected"}`,10,y); y+=6;
 pdf.text(`Tongue Obstruction: ${tongue.checked?"Yes":"No"}`,10,y); y+=8;

 pdf.text("Mallampati Rationale:",10,y); y+=6;
 pdf.text(`Soft palate visible: ${softPalate.checked?"Yes":"No"}`,14,y); y+=5;
 pdf.text(`Uvula visible: ${uvula.checked?"Yes":"No"}`,14,y); y+=5;
 pdf.text(`Faucial pillars visible: ${pillars.checked?"Yes":"No"}`,14,y); y+=5;
 pdf.text(`Only hard palate visible: ${hardPalate.checked?"Yes":"No"}`,14,y); y+=8;

 pdf.addImage(imgData["I1"],"JPEG",10,y,80,60);

 for(const v of views){
  pdf.addPage();
  pdf.text(`${v.id} — ${v.label}`,10,20);
  pdf.addImage(imgData[v.id],"JPEG",10,30,120,90);
 }

 pdf.setFontSize(10);
 pdf.text("Patent Pending · Non-diagnostic clinical documentation tool",10,290);

 pdf.save(`PreOp_${sid}.pdf`);
};
</script>
</body>
</html>
