<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin:30px; }
h1 { font-size:34px; }
h2 { margin-top:30px; }
.section { margin-bottom:30px; border-bottom:1px solid #ccc; padding-bottom:20px; }
.complete { color:green; font-weight:bold; }
.incomplete { color:red; font-weight:bold; }
img.preview { max-width:260px; display:block; margin-top:10px; border:1px solid #ccc; }
label { display:block; margin:6px 0; font-weight:bold; }
input[type=text], select, textarea {
  width:100%;
  padding:10px;
  font-size:16px;
  box-sizing:border-box;
}
textarea { min-height:80px; }
button { padding:12px 22px; font-size:18px; margin-top:20px; }
.readonly { background:#f4f4f4; }
</style>
</head>

<body>

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong><br><br>

<label>Patient / Session ID</label>
<input type="text" id="sessionId" value="Patient Pending">

<div class="section">
<h2>I1 — Airway View <span id="i1Status" class="incomplete">Incomplete</span></h2>

<input type="file" accept="image/*" onchange="loadImage(this,'airway')">
<img id="airway_preview" class="preview">

<label>Mallampati</label>
<select id="mallampati">
<option value="">Select</option>
<option>I</option>
<option>II</option>
<option>III</option>
<option>IV</option>
</select>

<label><input type="checkbox" id="tongueObs"> Tongue obstruction noted</label>

<label>Mallampati Rationale (Observed)</label>
<label><input type="checkbox" id="soft"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hard"> Only hard palate visible</label>
</div>

<div class="section">
<h2>Dentition Images</h2>
<div id="dentition"></div>
</div>

<div class="section">
<h2>Clinical Interpretation</h2>

<label>Airway Risk</label>
<input id="airwayRisk" class="readonly" readonly>

<label>Risk Description</label>
<textarea id="riskDescription" class="readonly" readonly></textarea>

<label>Interpretation</label>
<textarea id="interpretation" class="readonly" readonly></textarea>

<label>Observed Findings</label>
<textarea id="observedFindings" class="readonly" readonly></textarea>
</div>

<div class="section">
<h2>Reviewer</h2>

<label>Reviewed By</label>
<input id="reviewerName">

<label>Role</label>
<select id="reviewerRole">
<option>Select</option>
<option>CRNA</option>
<option>MD</option>
<option>DO</option>
<option>DDS</option>
<option>RN</option>
<option>Resident</option>
</select>

<label><input type="checkbox" id="reviewed"> Reviewed prior to induction</label>
</div>

<button onclick="generatePDF()">Generate PDF Report</button>

<script>
const imageStore = {};

function loadImage(input, key){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    imageStore[key] = e.target.result;
    const img = document.getElementById(key+"_preview");
    if(img) img.src = e.target.result;
    if(key==="airway"){
      i1Status.textContent="Complete";
      i1Status.className="complete";
    }
  };
  reader.readAsDataURL(file);
}

const dentitionKeys = [
["i2","Upper Dentition"],
["i3","Lower Dentition"],
["i4","Right Molars"],
["i5","Left Molars"],
["i6","Natural Occlusion"]
];

dentitionKeys.forEach(d=>{
  const div=document.createElement("div");
  div.className="section";
  div.innerHTML=`
    <h3>${d[0].toUpperCase()} — ${d[1]}</h3>
    <input type="file" accept="image/*" onchange="loadImage(this,'${d[0]}')">
    <img id="${d[0]}_preview" class="preview">
  `;
  dentition.appendChild(div);
});

function updateClinical(){
  if(!mallampati.value) return;

  const high = mallampati.value==="III" || mallampati.value==="IV" || tongueObs.checked;
  airwayRisk.value = high ? "HIGH" : "LOW";

  riskDescription.value = high
    ? "Findings suggest increased difficulty with airway management. Preparation for advanced airway techniques is recommended."
    : "Findings suggest low anticipated difficulty with airway management.";

  interpretation.value =
    `Mallampati ${mallampati.value}` +
    (tongueObs.checked ? " with tongue obstruction noted." : ".");

  const findings=[];
  if(soft.checked) findings.push("Soft palate visible");
  if(uvula.checked) findings.push("Uvula visible");
  if(pillars.checked) findings.push("Faucial pillars visible");
  if(hard.checked) findings.push("Only hard palate visible");

  observedFindings.value = findings.join("; ");
}

document.querySelectorAll("input,select").forEach(e=>e.addEventListener("change",updateClinical));

async function generatePDF(){
  const wrap=document.createElement("div");
  wrap.style.padding="30px";
  wrap.style.background="white";

  const now=new Date().toLocaleString("en-US",{timeZone:"America/Chicago"});
  wrap.innerHTML=`
    <h1>Pre-Operative Dental & Airway Report</h1>
    <strong>Session ID:</strong> ${sessionId.value}<br>
    <strong>Capture Timestamp (CST):</strong> ${now}<br><br>

    <strong>Airway Risk:</strong> ${airwayRisk.value}<br><br>
    <strong>Risk Description:</strong><br>${riskDescription.value}<br><br>
    <strong>Interpretation:</strong><br>${interpretation.value}<br><br>
    <strong>Observed Findings:</strong><br>${observedFindings.value}<br><br>
  `;

  Object.entries(imageStore).forEach(([k,src])=>{
    const h=document.createElement("h3");
    h.textContent=k.toUpperCase();
    const img=document.createElement("img");
    img.src=src;
    img.style.maxWidth="100%";
    img.style.marginBottom="20px";
    wrap.appendChild(h);
    wrap.appendChild(img);
  });

  document.body.appendChild(wrap);
  await new Promise(r=>setTimeout(r,300));

  html2pdf().set({
    margin:10,
    filename:`PreOp_${sessionId.value}.pdf`,
    html2canvas:{scale:2},
    jsPDF:{unit:"mm",format:"a4"}
  }).from(wrap).save().then(()=>wrap.remove());
}
</script>

</body>
</html>
