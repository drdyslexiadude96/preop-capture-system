<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pre-Operative Dental & Airway Capture System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin: 30px; }
h1 { font-size: 34px; }
h2 { margin-top: 30px; }
.section { margin-bottom: 25px; }
label { display: block; margin: 6px 0; }
.complete { color: green; font-weight: bold; }
.incomplete { color: #999; }
button { padding: 10px 18px; font-size: 16px; }
input[type="text"] { padding: 5px; }
hr { margin: 25px 0; }
</style>
</head>

<body>

<!-- ================= LAYER 1 (LOCKED) ================= -->

<h1>Pre-Operative Dental & Airway Capture System</h1>
<strong>Patent Pending</strong><br><br>

<label>
Patient / Session ID:
<input type="text" id="sessionId" placeholder="Auto-generated if left blank">
</label>

<hr>

<div class="section">
<h2>I1 — Airway View</h2>

<input type="file" id="i1">
<label><input type="checkbox" id="tongueObs"> Tongue obstruction noted</label>

<label>
Mallampati:
<select id="mallampati">
<option value="">Select</option>
<option>I</option>
<option>II</option>
<option>III</option>
<option>IV</option>
</select>
</label>

<h3>Mallampati Rationale (Observed)</h3>
<label><input type="checkbox" id="soft"> Soft palate visible</label>
<label><input type="checkbox" id="uvula"> Uvula visible</label>
<label><input type="checkbox" id="pillars"> Faucial pillars visible</label>
<label><input type="checkbox" id="hard"> Only hard palate visible</label>
</div>

<hr>

<div class="section">
<h2>I2–I6 Dentition Images</h2>

<div>I2 — Upper Dentition <span id="s2" class="incomplete">Incomplete</span>
<input type="file" id="i2"></div>

<div>I3 — Lower Dentition <span id="s3" class="incomplete">Incomplete</span>
<input type="file" id="i3"></div>

<div>I4 — Right Molars <span id="s4" class="incomplete">Incomplete</span>
<input type="file" id="i4"></div>

<div>I5 — Left Molars <span id="s5" class="incomplete">Incomplete</span>
<input type="file" id="i5"></div>

<div>I6 — Natural Occlusion <span id="s6" class="incomplete">Incomplete</span>
<input type="file" id="i6"></div>
</div>

<hr>

<!-- ================= LAYER 2 (NEW – ONLY ADDITION) ================= -->

<div class="section">
<h2>Clinical Interpretation</h2>
<div id="interpretationText"><em>Complete airway inputs to generate interpretation.</em></div>

<h3>Reviewer</h3>
<label>Reviewed by: <input type="text" id="reviewer"></label>

<label>
Role:
<select id="role">
<option value="">Select</option>
<option>Anesthesiologist</option>
<option>CRNA</option>
<option>Other</option>
</select>
</label>

<label><input type="checkbox" id="reviewed"> Reviewed prior to induction</label>
</div>

<hr>

<button id="pdfBtn" disabled>Generate PDF Report</button>

<script>
/* ---------- Layer 1 logic (unchanged) ---------- */
const files = ["i2","i3","i4","i5","i6"];
files.forEach((id,i)=>{
  document.getElementById(id).addEventListener("change",()=>{
    document.getElementById("s"+(i+2)).textContent="Complete";
    document.getElementById("s"+(i+2)).className="complete";
    checkReady();
  });
});

function checkReady(){
  const all = files.every(id=>document.getElementById(id).files.length>0);
  document.getElementById("pdfBtn").disabled = !all;
}

function cstTime(){
  return new Date().toLocaleString("en-US",{
    timeZone:"America/Chicago",
    hour12:true
  });
}

/* ---------- Layer 2 logic ---------- */
function updateInterpretation(){
  const m = mallampati.value;
  const t = tongueObs.checked;

  if(!m){
    interpretationText.innerHTML =
      "<em>Complete airway inputs to generate interpretation.</em>";
    return;
  }

  let risk = "LOW";
  if(m==="III" || m==="IV" || t) risk = "MODERATE";
  if(m==="IV" && t) risk = "HIGH";

  interpretationText.innerHTML =
    "<strong>Airway Risk Stratification:</strong> "+risk+
    "<br><strong>Clinical Interpretation:</strong> Mallampati "+m+
    (t ? " with tongue obstruction noted." : ".");
}

mallampati.addEventListener("change", updateInterpretation);
tongueObs.addEventListener("change", updateInterpretation);

/* ---------- PDF ---------- */
pdfBtn.onclick = ()=>{
  const sid = sessionId.value || "SESSION-"+Date.now();

  const pdf = document.createElement("div");
  pdf.innerHTML = `
    <h1>Pre-Operative Dental & Airway Report</h1>
    <p><strong>Session ID:</strong> ${sid}</p>
    <p><strong>Capture Timestamp (CST):</strong> ${cstTime()}</p>

    <p><strong>Mallampati Class:</strong> ${mallampati.value}</p>
    <p><strong>Tongue Obstruction:</strong> ${tongueObs.checked?"Yes":"No"}</p>

    <p><strong>Mallampati Rationale:</strong><br>
    Soft palate visible: ${soft.checked?"Yes":"No"}<br>
    Uvula visible: ${uvula.checked?"Yes":"No"}<br>
    Faucial pillars visible: ${pillars.checked?"Yes":"No"}<br>
    Only hard palate visible: ${hard.checked?"Yes":"No"}</p>

    <p>${interpretationText.innerText}</p>

    <p><strong>Reviewed by:</strong> ${reviewer.value || "—"}</p>
    <p><strong>Role:</strong> ${role.value || "—"}</p>
    <p><strong>Reviewed prior to induction:</strong> ${reviewed.checked?"Yes":"No"}</p>
    <p><strong>Review Timestamp (CST):</strong> ${cstTime()}</p>

    <p><em>Patent Pending</em></p>
  `;

  html2pdf().from(pdf).save(`PreOp_${sid}.pdf`);
};
</script>

</body>
</html>
